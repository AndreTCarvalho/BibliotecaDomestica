{% extends "base.html" %}

{% block title %}
    {% if book %}Editar Livro{% else %}Adicionar Livro{% endif %}
{% endblock %}

{% block content %}
<div class="form-container">
    <h2>{% if book %}Editar Livro{% else %}Adicionar Novo Livro{% endif %}</h2>

    {# Botão Gemini para leitura do livro #}
    <div class="gemini-section" style="margin-bottom: 20px;">
        <h3>Preenchimento Automático com Gemini</h3>
        <p>Tire uma foto da capa do livro para o Gemini tentar preencher as informações automaticamente.</p>
        <button type="button" id="openCameraGeminiButton" class="btn btn-info">Abrir Câmera para Gemini</button>
        <div id="geminiCameraStream" style="display: none; margin-top: 10px;">
            <video id="geminiCameraFeed" width="320" height="240" autoplay></video>
            <button type="button" id="captureGeminiButton" class="btn btn-success">Analisar Foto com Gemini</button>
            <button type="button" id="closeGeminiCameraButton" class="btn btn-danger">Fechar Câmera</button>
            <p id="geminiLoading" style="display: none; margin-top: 10px; color: #007bff;">Analisando imagem com Gemini, aguarde...</p>
            <p id="geminiError" style="display: none; margin-top: 10px; color: red;"></p>
        </div>
    </div>

    <form method="POST" enctype="multipart/form-data" id="bookForm">
        <input type="hidden" name="id" value="{{ book.id if book }}">

        <div class="form-group">
            <label for="titulo">Título *</label>
            <input type="text" class="form-control" id="titulo" name="titulo" value="{{ book.titulo if book }}" required>
        </div>
        <div class="form-group">
            <label for="autor">Autor *</label>
            <input type="text" class="form-control" id="autor" name="autor" value="{{ book.autor if book }}" required>
        </div>
        <div class="form-group">
            <label for="genero">Gênero</label>
            <input type="text" class="form-control" id="genero" name="genero" value="{{ book.genero if book }}">
        </div>
        <div class="form-group">
            <label for="idioma">Idioma</label>
            <input type="text" class="form-control" id="idioma" name="idioma" value="{{ book.idioma if book }}">
        </div>
        <div class="form-group">
            <label for="resenha">Resenha</label>
            <textarea class="form-control" id="resenha" name="resenha" rows="5">{{ book.resenha if book }}</textarea>
        </div>

        <div class="form-group">
            <label for="estante">Estante</label>
            <input type="text" class="form-control" id="estante" name="estante" value="{{ book.estante if book }}">
        </div>
        <div class="form-group">
            <label for="prateleira">Prateleira</label>
            <input type="text" class="form-control" id="prateleira" name="prateleira" value="{{ book.prateleira if book }}">
        </div>

        {# Seletor de Opção de Capa #}
        <div class="form-group">
            <label for="cover_option">Opção de Capa:</label>
            <select class="form-control" id="cover_option" name="cover_option">
                <option value="none">Nenhuma</option>
                <option value="file" {% if book and book.capa and not book.capa.startswith('http') and not book.capa.startswith('data:image') %}selected{% endif %}>Carregar Arquivo</option>
                <option value="camera">Tirar Foto com Câmera</option>
                <option value="url" {% if book and book.capa and book.capa.startswith('http') %}selected{% endif %}>Usar URL da Imagem</option>
                {% if book and book.capa and book.capa.startswith('data:image') %}
                    <option value="current_camera" selected>Manter Foto da Câmera Atual</option>
                {% endif %}
            </select>
        </div>

        {# Campos e Pré-visualizações das Capas #}
        <div id="cover_file_section" style="display: none;">
            <div class="form-group">
                <label for="capa_file">Carregar Arquivo de Imagem</label>
                <input type="file" class="form-control-file" id="capa_file" name="capa_file" accept="image/*">
                <div id="file-preview-container" style="margin-top: 10px; display: none;">
                    <img id="file-preview" src="#" alt="Prévia da Capa" style="max-width: 200px; max-height: 200px;">
                </div>
            </div>
        </div>

        <div id="cover_camera_section" style="display: none;">
            <div class="form-group">
                <label>Tirar Foto com Câmera</label>
                <button type="button" id="openBookCameraButton" class="btn btn-secondary btn-sm">Abrir Câmera</button>
                <div id="bookCameraStream" style="display: none; margin-top: 10px;">
                    <video id="bookCameraFeed" width="320" height="240" autoplay></video>
                    <button type="button" id="captureBookButton" class="btn btn-primary btn-sm">Capturar Foto</button>
                    <button type="button" id="closeBookCameraButton" class="btn btn-danger btn-sm">Fechar Câmera</button>
                </div>
                <div id="book-camera-preview-container" style="margin-top: 10px; display: none;">
                    <img id="book-camera-preview" src="#" alt="Foto da Câmera" style="max-width: 200px; max-height: 200px;">
                </div>
                <input type="hidden" id="capa_camera_data" name="capa_camera_data" value="{{ book.capa if book and book.capa and book.capa.startswith('data:image') }}">
            </div>
        </div>

        <div id="cover_url_section" style="display: none;">
            <div class="form-group">
                <label for="capa_url">URL da Imagem da Capa</label>
                <input type="url" class="form-control" id="capa_url" name="capa_url" value="{{ book.capa if book and book.capa and book.capa.startswith('http') }}">
                <div id="url-preview-container" style="margin-top: 10px; display: none;">
                    <img id="url-preview" src="#" alt="Prévia da Capa" style="max-width: 200px; max-height: 200px;">
                </div>
            </div>
        </div>

        {# Campo oculto para manter a capa atual se nenhuma nova for selecionada (caso de edição) #}
        {% if book and book.capa and not book.capa.startswith('data:image') %}
        <div id="current_cover_section" style="margin-top: 20px; display: block;">
            <p>Capa Atual:</p>
            {% if book.capa.startswith('http') %}
                <img src="{{ book.capa }}" alt="Capa Atual" style="max-width: 200px; max-height: 200px;">
            {% else %}
                <img src="{{ url_for('uploaded_file', filename=book.capa) }}" alt="Capa Atual" style="max-width: 200px; max-height: 200px;">
            {% endif %}
            <input type="hidden" name="keep_current_cover" id="keep_current_cover" value="true">
        </div>
        {% elif book and book.capa and book.capa.startswith('data:image') %}
            {# A capa da câmera é tratada como "current_camera" option no select #}
        {% endif %}


        <button type="submit" class="btn btn-primary">Salvar Livro</button>
        <a href="{{ url_for('index') }}" class="btn btn-secondary">Cancelar</a>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Elementos Comuns ---
        const form = document.getElementById('bookForm');

        // --- Seletor de Opção de Capa ---
        const coverOptionSelect = document.getElementById('cover_option');
        const coverFileSection = document.getElementById('cover_file_section');
        const coverCameraSection = document.getElementById('cover_camera_section');
        const coverUrlSection = document.getElementById('cover_url_section');
        const currentCoverSection = document.getElementById('current_cover_section');
        const keepCurrentCoverInput = document.getElementById('keep_current_cover'); // hidden input

        // --- Elementos de Upload de Arquivo ---
        const fileInput = document.getElementById('capa_file');
        const filePreviewContainer = document.getElementById('file-preview-container');
        const filePreview = document.getElementById('file-preview');

        // --- Elementos da Câmera (Formulário do Livro) ---
        const openBookCameraButton = document.getElementById('openBookCameraButton');
        const bookCameraFeed = document.getElementById('bookCameraFeed');
        const captureBookButton = document.getElementById('captureBookButton');
        const closeBookCameraButton = document.getElementById('closeBookCameraButton');
        const bookCameraStreamDiv = document.getElementById('bookCameraStream');
        const bookCameraPreviewContainer = document.getElementById('book-camera-preview-container');
        const bookCameraPreview = document.getElementById('book-camera-preview');
        const capaCameraDataInput = document.getElementById('capa_camera_data'); // Hidden input para dados da câmera

        let bookCameraStream; // Stream da câmera para o formulário do livro

        // --- Elementos de URL da Imagem ---
        const capaUrlInput = document.getElementById('capa_url');
        const urlPreviewContainer = document.getElementById('url-preview-container');
        const urlPreview = document.getElementById('url-preview');

        // --- Elementos Gemini ---
        const openCameraGeminiButton = document.getElementById('openCameraGeminiButton');
        const geminiCameraFeed = document.getElementById('geminiCameraFeed');
        const captureGeminiButton = document.getElementById('captureGeminiButton');
        const closeGeminiCameraButton = document.getElementById('closeGeminiCameraButton');
        const geminiCameraStreamDiv = document.getElementById('geminiCameraStream');
        const geminiLoading = document.getElementById('geminiLoading');
        const geminiError = document.getElementById('geminiError');

        let geminiCameraStream; // Stream da câmera para o Gemini

        // --- Funções Auxiliares ---

        // Função para mostrar/esconder seções de capa
        function toggleCoverSections(selectedOption) {
            coverFileSection.style.display = 'none';
            coverCameraSection.style.display = 'none';
            coverUrlSection.style.display = 'none';
            if (currentCoverSection) { // Apenas se existir
                currentCoverSection.style.display = 'none';
            }

            // Limpa todas as pré-visualizações e inputs ocultos ao trocar de opção
            filePreview.src = '#';
            filePreviewContainer.style.display = 'none';
            bookCameraPreview.src = '#';
            bookCameraPreviewContainer.style.display = 'none';
            urlPreview.src = '#';
            urlPreviewContainer.style.display = 'none';

            capaCameraDataInput.value = '';
            fileInput.value = ''; // Limpa o input de arquivo
            capaUrlInput.value = ''; // Limpa o input de URL

            if (keepCurrentCoverInput) {
                keepCurrentCoverInput.value = 'false'; // Assume que não manterá a capa atual
            }


            // Para streams de câmera abertos
            if (bookCameraStream) {
                bookCameraStream.getTracks().forEach(track => track.stop());
                bookCameraFeed.srcObject = null;
                bookCameraStreamDiv.style.display = 'none';
            }
            if (geminiCameraStream) { // Fecha a câmera do Gemini se estiver aberta
                 geminiCameraStream.getTracks().forEach(track => track.stop());
                 geminiCameraFeed.srcObject = null;
                 geminiCameraStreamDiv.style.display = 'none';
            }


            switch (selectedOption) {
                case 'file':
                    coverFileSection.style.display = 'block';
                    break;
                case 'camera':
                    coverCameraSection.style.display = 'block';
                    break;
                case 'url':
                    coverUrlSection.style.display = 'block';
                    break;
                case 'current_camera': // Se a opção for manter a foto da câmera atual
                    // A capa da câmera é tratada como "current_camera" option no select
                    // book.capa é o valor do input hidden capa_camera_data
                    if (capaCameraDataInput.value) { // Verifica se há um valor na capa_camera_data
                        bookCameraPreview.src = capaCameraDataInput.value;
                        bookCameraPreviewContainer.style.display = 'block';
                    }
                    if (keepCurrentCoverInput) {
                        keepCurrentCoverInput.value = 'true'; // Sinaliza para manter a capa atual
                    }
                    break;
                case 'none':
                    // Se 'none' for selecionada e houver uma capa atual que não seja base64, mostre-a
                    {% if book and book.capa and not book.capa.startswith('data:image') %}
                        if (currentCoverSection) {
                            currentCoverSection.style.display = 'block';
                        }
                    {% else %}
                        // Se não há capa ou é base64, não mostre a seção de capa atual
                    {% endif %}
                    if (keepCurrentCoverInput) {
                        keepCurrentCoverInput.value = 'true';
                    }
                    break;
            }
        }

        // --- Inicialização ao carregar a página (para edição) ---
        // Exibe a seção de capa correta e a prévia se houver uma capa existente
        const initialCoverOption = coverOptionSelect.value;
        toggleCoverSections(initialCoverOption);

        // Se o livro já tem uma capa de URL, preenche a prévia
        // Adicionado 'book.capa &&' para garantir que a capa não é None
        {% if book and book.capa and book.capa.startswith('http') %}
            urlPreview.src = "{{ book.capa }}";
            urlPreviewContainer.style.display = 'block';
        {% endif %}
        // Se o livro já tem uma capa de câmera (base64), preenche a prévia
        {% if book and book.capa and book.capa.startswith('data:image') %}
             bookCameraPreview.src = "{{ book.capa }}";
             bookCameraPreviewContainer.style.display = 'block';
        {% endif %}


        // --- Event Listeners ---

        // Quando o tipo de capa é alterado
        coverOptionSelect.addEventListener('change', function() {
            toggleCoverSections(this.value);
        });

        // Prévia do upload de arquivo
        fileInput.addEventListener('change', function() {
            const file = this.files?.[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    filePreview.src = e.target.result;
                    filePreviewContainer.style.display = 'block';
                }
                reader.readAsDataURL(file);
            } else {
                filePreview.src = '#';
                filePreviewContainer.style.display = 'none';
            }
        });

        // Prévia da URL da imagem
        capaUrlInput.addEventListener('input', function() {
            const url = this.value.trim();
            if (url) {
                urlPreview.src = url;
                urlPreviewContainer.style.display = 'block';
                // Adicionar tratamento de erro para URL inválida/não carregável (ex: onerror)
                urlPreview.onerror = () => {
                    urlPreview.src = '#'; // Limpa a prévia
                    urlPreviewContainer.style.display = 'none';
                    // alert("Não foi possível carregar a imagem da URL. Verifique o endereço.");
                };
            } else {
                urlPreview.src = '#';
                urlPreviewContainer.style.display = 'none';
            }
        });


        // --- Lógica da Câmera (Para Capa do Livro) ---
        if (openBookCameraButton) {
            openBookCameraButton.addEventListener('click', async () => {
                try {
                    // Fecha a câmera do Gemini se estiver aberta
                    if (geminiCameraStream) {
                        geminiCameraStream.getTracks().forEach(track => track.stop());
                        geminiCameraFeed.srcObject = null;
                        geminiCameraStreamDiv.style.display = 'none';
                    }

                    bookCameraStream = await navigator.mediaDevices.getUserMedia({ video: true });
                    bookCameraFeed.srcObject = bookCameraStream;
                    bookCameraFeed.play();
                    bookCameraStreamDiv.style.display = 'block';
                    bookCameraPreviewContainer.style.display = 'none'; // Esconde a prévia ao abrir a câmera
                } catch (err) {
                    console.error("Erro ao acessar a câmera (capa do livro): ", err);
                    alert("Não foi possível acessar a câmera para a capa do livro. Verifique as permissões ou se está acessando via HTTPS/localhost.");
                }
            });
        }

        if (captureBookButton) {
            captureBookButton.addEventListener('click', () => {
                const canvas = document.createElement('canvas');
                canvas.width = bookCameraFeed.videoWidth;
                canvas.height = bookCameraFeed.videoHeight;
                const context = canvas.getContext('2d');
                context.drawImage(bookCameraFeed, 0, 0, canvas.width, canvas.height);
                const imageDataURL = canvas.toDataURL('image/png'); // Base64
                bookCameraPreview.src = imageDataURL;
                bookCameraPreviewContainer.style.display = 'block';
                capaCameraDataInput.value = imageDataURL; // Define o hidden input

                // Parar o stream da câmera após capturar
                if (bookCameraStream) {
                    bookCameraStream.getTracks().forEach(track => track.stop());
                    bookCameraFeed.srcObject = null;
                    bookCameraStreamDiv.style.display = 'none';
                }
            });
        }

        if (closeBookCameraButton) {
            closeBookCameraButton.addEventListener('click', () => {
                if (bookCameraStream) {
                    bookCameraStream.getTracks().forEach(track => track.stop());
                    bookCameraFeed.srcObject = null;
                    bookCameraStreamDiv.style.display = 'none';
                }
                bookCameraPreview.src = '#';
                bookCameraPreviewContainer.style.display = 'none';
                capaCameraDataInput.value = ''; // Limpa o valor do input oculto
            });
        }


        // --- Lógica da Câmera (Para Gemini) ---
        if (openCameraGeminiButton) {
            openCameraGeminiButton.addEventListener('click', async () => {
                try {
                    // Fecha a câmera do livro se estiver aberta
                    if (bookCameraStream) {
                        bookCameraStream.getTracks().forEach(track => track.stop());
                        bookCameraFeed.srcObject = null;
                        bookCameraStreamDiv.style.display = 'none';
                    }

                    geminiCameraStream = await navigator.mediaDevices.getUserMedia({ video: true });
                    geminiCameraFeed.srcObject = geminiCameraStream;
                    geminiCameraFeed.play();
                    geminiCameraStreamDiv.style.display = 'block';
                    geminiError.style.display = 'none'; // Limpa mensagens de erro anteriores
                } catch (err) {
                    console.error("Erro ao acessar a câmera (Gemini): ", err);
                    alert("Não foi possível acessar a câmera para o Gemini. Verifique as permissões ou se está acessando via HTTPS/localhost.");
                }
            });
        }

        if (captureGeminiButton) {
            captureGeminiButton.addEventListener('click', async () => {
                const canvas = document.createElement('canvas');
                canvas.width = geminiCameraFeed.videoWidth;
                canvas.height = geminiCameraFeed.videoHeight;
                const context = canvas.getContext('2d');
                context.drawImage(geminiCameraFeed, 0, 0, canvas.width, canvas.height);
                const imageDataBlob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg')); // Converte para Blob JPEG

                if (geminiCameraStream) { // Parar o stream da câmera após capturar
                    geminiCameraStream.getTracks().forEach(track => track.stop());
                    geminiCameraFeed.srcObject = null;
                    geminiCameraStreamDiv.style.display = 'none';
                }

                geminiLoading.style.display = 'block'; // Mostra mensagem de carregamento
                geminiError.style.display = 'none';    // Esconde erro anterior

                // Envia a imagem para o backend Flask para processamento com Gemini
                const formData = new FormData();
                formData.append('image', imageDataBlob, 'gemini_capture.jpeg'); // Adiciona o Blob

                try {
                    const response = await fetch('/process_camera_image', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Preenche os campos do formulário com os dados do Gemini
                        document.getElementById('titulo').value = data.data.titulo || '';
                        document.getElementById('autor').value = data.data.autor || '';
                        document.getElementById('genero').value = data.data.genero || '';
                        document.getElementById('idioma').value = data.data.idioma || '';
                        document.getElementById('resenha').value = data.data.resenha || '';

                        // Se o Gemini extraiu a capa, atualize a prévia da capa de "URL" ou "Câmera"
                        // Neste caso, a imagem capturada para o Gemini não é a capa do livro,
                        // é apenas para análise. Se você quiser usar a mesma imagem como capa,
                        // precisaria de uma lógica adicional para mover o temp_image_path para o input de capa.
                        // Por simplicidade, vamos deixar a seleção da capa separada.

                        alert('Informações do livro preenchidas com sucesso pelo Gemini!');
                    } else {
                        geminiError.textContent = 'Erro ao processar imagem com Gemini: ' + (data.error || 'Erro desconhecido.');
                        geminiError.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Erro na requisição Gemini:', error);
                    geminiError.textContent = 'Erro de rede ou servidor ao tentar processar com Gemini.';
                    geminiError.style.display = 'block';
                } finally {
                    geminiLoading.style.display = 'none'; // Esconde mensagem de carregamento
                }
            });
        }

        if (closeGeminiCameraButton) {
            closeGeminiCameraButton.addEventListener('click', () => {
                if (geminiCameraStream) {
                    geminiCameraStream.getTracks().forEach(track => track.stop());
                    geminiCameraFeed.srcObject = null;
                    geminiCameraStreamDiv.style.display = 'none';
                }
                geminiLoading.style.display = 'none';
                geminiError.style.display = 'none';
            });
        }

        // --- Tratamento do formulário para garantir que apenas UM tipo de capa seja enviado ---
        form.addEventListener('submit', function(event) {
            // Limpa os valores dos inputs de capa que não estão selecionados
            const selectedOption = coverOptionSelect.value;

            if (selectedOption !== 'file') {
                fileInput.value = ''; // Limpa o input de arquivo
            }
            // A capa da câmera é 'capa_camera_data'. Se a opção não for 'camera' nem 'current_camera', limpa.
            if (selectedOption !== 'camera' && selectedOption !== 'current_camera') {
                capaCameraDataInput.value = ''; // Limpa o input de dados da câmera
            }
            if (selectedOption !== 'url') {
                capaUrlInput.value = ''; // Limpa o input de URL
            }

            // A lógica para 'keep_current_cover' é mais complexa, pois depende do estado original do livro
            // e se 'none' ou 'current_camera' foram explicitamente selecionados.
            // Para simplificar, vamos garantir que se "none" ou "current_camera" for selecionado,
            // e o livro já tinha uma capa, ela será mantida (ou removida se "none" e não base64).
            // No backend, você terá que lidar com o caso onde keep_current_cover é true.
            if (keepCurrentCoverInput) {
                if (selectedOption === 'none' || selectedOption === 'current_camera') {
                     // Se o livro já tem uma capa, e a opção selecionada é "none" ou "current_camera"
                     // (que na verdade significa "manter a capa que já existe"), sinalize para manter.
                    {% if book and book.capa %}
                        keepCurrentCoverInput.value = 'true';
                    {% else %}
                        keepCurrentCoverInput.value = 'false'; // Se não há capa, não há o que manter
                    {% endif %}
                } else {
                    keepCurrentCoverInput.value = 'false'; // Uma nova opção de capa foi selecionada
                }
            }
        });
    });
</script>
{% endblock %}